
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punch Needle Pattern Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    div {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        padding: 30px;
    }

    h1 {
        font-size: 2.5rem;
        color: white;
        background: linear-gradient(135deg, #2c3e50, #3498db);
        padding: 30px;
        text-align: center;
        border-radius: 15px;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    p, small {
        text-align: center;
        color: #555;
    }

    #uploadSection {
        background: #f8f9fa;
        border: 3px dashed #dee2e6;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: all 0.3s ease;
    }

    #uploadSection:hover {
        border-color: #3498db;
        background: #e3f2fd;
    }

    button {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 10px;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }

    button:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    label {
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
        color: #2c3e50;
    }

    select, input[type="range"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 2px solid #dee2e6;
        border-radius: 5px;
        font-size: 1rem;
    }

    input[type="range"]:focus,
    select:focus {
        border-color: #3498db;
        outline: none;
    }

    span {
        font-weight: bold;
        display: inline-block;
        margin-bottom: 15px;
        color: #34495e;
    }

    #originalPreview, #patternPreview {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        min-height: 300px;
        margin-top: 20px;
        border: 2px solid #e9ecef;
    }

    h3 {
        margin-top: 30px;
        color: #2c3e50;
        text-align: center;
    }

    #colorPalette {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    #colorPalette .color-swatch {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
        color: #fff;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    #loading {
        display: none;
        text-align: center;
        padding: 20px;
    }

    #loading div {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    #stats {
        background: #e8f5e8;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        border-left: 5px solid #27ae60;
    }

    #stats h4 {
        color: #27ae60;
        margin-bottom: 10px;
    }

    #threadCount {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }

    #threadCount > div {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px;
        background: white;
        border-radius: 5px;
    }

    @media (max-width: 768px) {
        div {
            padding: 20px;
        }

        button {
            width: 100%;
        }

        #colorPalette {
            justify-content: center;
        }
    }
</style>

</head>
<body>
    <div>
        <h1>Punch Needle Pattern Generator</h1>
        <p>Transform your photos into beautiful punch needle patterns</p>

        <div id="uploadSection">
            <input type="file" id="imageInput" accept="image/*">
            <button onclick="document.getElementById('imageInput').click()">
                Choose Image
            </button>
            <p>or drag and drop an image here</p>
            <small>Supported formats: JPG, PNG, GIF</small>
        </div>

        <div>
            <div>
                <label for="colorCount">Number of Colors:</label>
                <select id="colorCount">
                    <option value="4">4 Colors</option>
                    <option value="5" selected>5 Colors</option>
                    <option value="6">6 Colors</option>
                </select>
            </div>

            <div>
                <label for="patternSize">Pattern Size:</label>
                <select id="patternSize">
                    <option value="small">Small (50x50)</option>
                    <option value="medium" selected>Medium (80x80)</option>
                    <option value="large">Large (120x120)</option>
                </select>
            </div>

            <div>
                <label for="orientation">Orientation:</label>
                <select id="orientation">
                    <option value="auto" selected>Auto</option>
                    <option value="portrait">Portrait</option>
                    <option value="landscape">Landscape</option>
                    <option value="square">Square</option>
                </select>
            </div>

            <div>
                <label for="contrast">Contrast Enhancement:</label>
                <input type="range" id="contrast" min="0.5" max="3" step="0.1" value="1.8">
                <span id="contrastValue">1.8</span>
            </div>

            <div>
                <label for="brightness">Brightness:</label>
                <input type="range" id="brightness" min="-50" max="50" step="5" value="0">
                <span id="brightnessValue">0</span>
            </div>

            <div>
                <label for="blur">Edge Smoothing:</label>
                <input type="range" id="blur" min="0" max="3" step="0.5" value="0.5">
                <span id="blurValue">0.5</span>
            </div>
        </div>

        <div>
            <div>
                <h3>Original Image</h3>
                <div id="originalPreview">
                    <p>Upload an image to see preview</p>
                </div>
            </div>

            <div>
                <h3>Pattern Preview</h3>
                <div id="patternPreview">
                    <p>Process image to see pattern</p>
                </div>
                <div id="colorPalette"></div>
            </div>
        </div>

        <div id="loading" style="display: none;">
            <div>Processing...</div>
            <p>Processing your image...</p>
        </div>

        <div>
            <button id="processBtn" onclick="processImage()" disabled>
                Generate Pattern
            </button>
            <button id="exportBtn" onclick="exportPDF()" disabled>
                Export PDF Pattern
            </button>
        </div>

        <div id="stats" style="display: none;">
            <h4>Pattern Statistics</h4>
            <div id="patternStats"></div>
            <div id="threadCount"></div>
        </div>
    </div> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punch Needle Pattern Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 3px dashed #dee2e6;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .upload-section.dragover {
            border-color: #2980b9;
            background: #bbdefb;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .control-group input, .control-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .preview-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid #e9ecef;
        }

        .preview-box h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .preview-img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .pattern-canvas {
            border: 1px solid #ddd;
            border-radius: 10px;
            max-width: 100%;
            max-height: 250px;
        }

        .color-palette {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .process-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .process-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .export-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .export-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stats {
            background: #e8f5e8;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #27ae60;
        }

        .stats h4 {
            color: #27ae60;
            margin-bottom: 10px;
        }

        .thread-count {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .thread-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            background: white;
            border-radius: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .buttons-section {
            text-align: center;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .preview-section {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Punch Needle Pattern Generator</h1>
            <p>Transform your photos into beautiful punch needle patterns</p>
        </div>

        <div class="content">
            <div class="upload-section" id="uploadSection">
                <input type="file" id="imageInput" class="file-input" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                    ðŸ“¸ Choose Image
                </button>
                <p>or drag and drop an image here</p>
                <small>Supported formats: JPG, PNG, GIF</small>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="colorCount">Number of Colors:</label>
                    <select id="colorCount">
                        <option value="4">4 Colors</option>
                        <option value="5" selected>5 Colors</option>
                        <option value="6">6 Colors</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="patternSize">Pattern Size:</label>
                    <select id="patternSize">
                        <option value="small">Small (50x50)</option>
                        <option value="medium" selected>Medium (80x80)</option>
                        <option value="large">Large (120x120)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="orientation">Orientation:</label>
                    <select id="orientation">
                        <option value="auto" selected>Auto</option>
                        <option value="portrait">Portrait</option>
                        <option value="landscape">Landscape</option>
                        <option value="square">Square</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="contrast">Contrast Enhancement:</label>
                    <input type="range" id="contrast" min="0.5" max="3" step="0.1" value="1.8">
                    <span id="contrastValue">1.8</span>
                </div>

                <div class="control-group">
                    <label for="brightness">Brightness:</label>
                    <input type="range" id="brightness" min="-50" max="50" step="5" value="0">
                    <span id="brightnessValue">0</span>
                </div>

                <div class="control-group">
                    <label for="blur">Edge Smoothing:</label>
                    <input type="range" id="blur" min="0" max="3" step="0.5" value="0.5">
                    <span id="blurValue">0.5</span>
                </div>
            </div>

            <div class="preview-section">
                <div class="preview-box">
                    <h3>Original Image</h3>
                    <div id="originalPreview">
                        <p>Upload an image to see preview</p>
                    </div>
                </div>

                <div class="preview-box">
                    <h3>Pattern Preview</h3>
                    <div id="patternPreview">
                        <p>Process image to see pattern</p>
                    </div>
                    <div id="colorPalette" class="color-palette"></div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your image...</p>
            </div>

            <div class="buttons-section">
                <button class="process-btn" id="processBtn" onclick="processImage()" disabled>
                    ðŸŽ¨ Generate Pattern
                </button>
                <button class="export-btn" id="exportBtn" onclick="exportPDF()" disabled>
                    ðŸ“„ Export PDF Pattern
                </button>
            </div>

            <div class="stats" id="stats" style="display: none;">
                <h4>Pattern Statistics</h4>
                <div id="patternStats"></div>
                <div class="thread-count" id="threadCount"></div>
            </div>
        </div>
    </div>

    <script>
        let originalImage = null;
        let processedCanvas = null;
        let colorPalette = [];
        let threadCounts = {};

        // Enhanced MAII Grayscale Palette with better contrast
        const MAII_PALETTE = {
            4: [
                { name: 'White', rgb: [255, 255, 255], hex: '#FFFFFF' },
                { name: 'Light Gray', rgb: [180, 180, 180], hex: '#B4B4B4' },
                { name: 'Dark Gray', rgb: [70, 70, 70], hex: '#464646' },
                { name: 'Black', rgb: [0, 0, 0], hex: '#000000' }
            ],
            5: [
                { name: 'White', rgb: [255, 255, 255], hex: '#FFFFFF' },
                { name: 'Light Gray', rgb: [200, 200, 200], hex: '#C8C8C8' },
                { name: 'Medium Gray', rgb: [128, 128, 128], hex: '#808080' },
                { name: 'Dark Gray', rgb: [64, 64, 64], hex: '#404040' },
                { name: 'Black', rgb: [0, 0, 0], hex: '#000000' }
            ],
            6: [
                { name: 'White', rgb: [255, 255, 255], hex: '#FFFFFF' },
                { name: 'Very Light Gray', rgb: [212, 212, 212], hex: '#D4D4D4' },
                { name: 'Light Gray', rgb: [170, 170, 170], hex: '#AAAAAA' },
                { name: 'Medium Gray', rgb: [128, 128, 128], hex: '#808080' },
                { name: 'Dark Gray', rgb: [64, 64, 64], hex: '#404040' },
                { name: 'Black', rgb: [0, 0, 0], hex: '#000000' }
            ]
        };

        // Update slider value displays
        document.getElementById('contrast').addEventListener('input', function() {
            document.getElementById('contrastValue').textContent = this.value;
        });
        
        document.getElementById('brightness').addEventListener('input', function() {
            document.getElementById('brightnessValue').textContent = this.value;
        });
        
        document.getElementById('blur').addEventListener('input', function() {
            document.getElementById('blurValue').textContent = this.value;
        });

        // File upload handling
        const imageInput = document.getElementById('imageInput');
        const uploadSection = document.getElementById('uploadSection');
        const processBtn = document.getElementById('processBtn');

        imageInput.addEventListener('change', handleImageUpload);

        // Drag and drop functionality
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.backgroundColor = '#e3f2fd';
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.style.backgroundColor = '';
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.backgroundColor = '';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFile(files[0]);
            }
        });

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        }

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    displayOriginalImage(img);
                    processBtn.disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function displayOriginalImage(img) {
            const preview = document.getElementById('originalPreview');
            preview.innerHTML = '';
            
            const displayImg = img.cloneNode();
            displayImg.style.maxWidth = '250px';
            displayImg.style.maxHeight = '250px';
            displayImg.style.borderRadius = '10px';
            preview.appendChild(displayImg);
        }

        function processImage() {
            if (!originalImage) return;

            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            setTimeout(() => {
                try {
                    const colorCount = parseInt(document.getElementById('colorCount').value);
                    const patternSize = document.getElementById('patternSize').value;
                    const orientation = document.getElementById('orientation').value;
                    const contrast = parseFloat(document.getElementById('contrast').value);
                    const brightness = parseInt(document.getElementById('brightness').value);
                    const blur = parseFloat(document.getElementById('blur').value);

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Determine canvas size
                    let canvasSize;
                    switch(patternSize) {
                        case 'small': canvasSize = 50; break;
                        case 'medium': canvasSize = 80; break;
                        case 'large': canvasSize = 120; break;
                    }

                    // Set canvas dimensions based on orientation
                    let canvasWidth, canvasHeight;
                    const imgAspectRatio = originalImage.width / originalImage.height;

                    if (orientation === 'square') {
                        canvasWidth = canvasHeight = canvasSize;
                    } else if (orientation === 'portrait') {
                        canvasHeight = canvasSize;
                        canvasWidth = Math.round(canvasSize * 0.75);
                    } else if (orientation === 'landscape') {
                        canvasWidth = canvasSize;
                        canvasHeight = Math.round(canvasSize * 0.75);
                    } else { // auto
                        if (imgAspectRatio > 1) {
                            canvasWidth = canvasSize;
                            canvasHeight = Math.round(canvasSize / imgAspectRatio);
                        } else {
                            canvasHeight = canvasSize;
                            canvasWidth = Math.round(canvasSize * imgAspectRatio);
                        }
                    }

                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;

                    // Draw image with initial processing
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(originalImage, 0, 0, canvasWidth, canvasHeight);
                    
                    // Apply blur for edge smoothing if needed
                    if (blur > 0) {
                        ctx.filter = `blur(${blur}px)`;
                        ctx.drawImage(canvas, 0, 0);
                        ctx.filter = 'none';
                    }

                    // Get image data and apply enhancements
                    const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
                    
                    // Apply brightness and contrast
                    applyBrightnessContrast(imageData, brightness, contrast);
                    
                    // Enhanced conversion to grayscale with better edge detection
                    convertToEnhancedGrayscale(imageData);
                    
                    // Apply posterization effect
                    applyPosterization(imageData, colorCount);
                    
                    // Final quantization to palette
                    const quantizedData = quantizeToGrayscale(imageData, colorCount);
                    ctx.putImageData(quantizedData, 0, 0);

                    // Apply final sharpening
                    applySharpen(ctx, canvasWidth, canvasHeight);

                    // Create pattern display
                    createPatternDisplay(canvas, canvasWidth, canvasHeight);
                    
                    processedCanvas = canvas;
                    updateColorPalette(colorCount);
                    calculateThreadCounts(quantizedData, colorCount);
                    
                    document.getElementById('exportBtn').disabled = false;
                    document.getElementById('stats').style.display = 'block';

                } catch (error) {
                    console.error('Error processing image:', error);
                    alert('Error processing image. Please try again.');
                } finally {
                    loading.style.display = 'none';
                }
            }, 100);
        }

        function applyBrightnessContrast(imageData, brightness, contrast) {
            const data = imageData.data;
            const factor = (259 * (contrast * 100 + 255)) / (255 * (259 - contrast * 100));
            
            for (let i = 0; i < data.length; i += 4) {
                // Apply brightness
                let r = data[i] + brightness;
                let g = data[i + 1] + brightness;
                let b = data[i + 2] + brightness;
                
                // Apply contrast
                r = factor * (r - 128) + 128;
                g = factor * (g - 128) + 128;
                b = factor * (b - 128) + 128;
                
                // Clamp values
                data[i] = Math.max(0, Math.min(255, r));
                data[i + 1] = Math.max(0, Math.min(255, g));
                data[i + 2] = Math.max(0, Math.min(255, b));
            }
        }

        function convertToEnhancedGrayscale(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // Create a copy for edge detection
            const edgeData = new Uint8ClampedArray(data);
            
            for (let i = 0; i < data.length; i += 4) {
                // Enhanced grayscale conversion with weighted luminance
                const gray = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                
                // Apply edge enhancement
                const x = (i / 4) % width;
                const y = Math.floor((i / 4) / width);
                
                let edgeEnhanced = gray;
                if (x > 0 && x < width - 1 && y > 0 && y < height - 1) {
                    // Simple edge detection kernel
                    const neighbors = [
                        getGrayValue(edgeData, x-1, y-1, width),
                        getGrayValue(edgeData, x, y-1, width),
                        getGrayValue(edgeData, x+1, y-1, width),
                        getGrayValue(edgeData, x-1, y, width),
                        gray,
                        getGrayValue(edgeData, x+1, y, width),
                        getGrayValue(edgeData, x-1, y+1, width),
                        getGrayValue(edgeData, x, y+1, width),
                        getGrayValue(edgeData, x+1, y+1, width)
                    ];
                    
                    // Edge enhancement
                    const center = neighbors[4];
                    const surrounding = (neighbors[0] + neighbors[1] + neighbors[2] + 
                                       neighbors[3] + neighbors[5] + neighbors[6] + 
                                       neighbors[7] + neighbors[8]) / 8;
                    
                    const edge = Math.abs(center - surrounding);
                    edgeEnhanced = Math.max(0, Math.min(255, gray + edge * 0.5));
                }
                
                data[i] = edgeEnhanced;
                data[i + 1] = edgeEnhanced;
                data[i + 2] = edgeEnhanced;
            }
        }

        function getGrayValue(data, x, y, width) {
            const index = (y * width + x) * 4;
            return Math.round(0.299 * data[index] + 0.587 * data[index + 1] + 0.114 * data[index + 2]);
        }

        function applyPosterization(imageData, levels) {
            const data = imageData.data;
            const factor = 255 / (levels - 1);
            
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i];
                const posterized = Math.round(Math.round(gray / factor) * factor);
                
                data[i] = posterized;
                data[i + 1] = posterized;
                data[i + 2] = posterized;
            }
        }

        function applySharpen(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const newData = new Uint8ClampedArray(data);
            
            // Sharpening kernel
            const kernel = [
                0, -1, 0,
                -1, 5, -1,
                0, -1, 0
            ];
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    
                    let r = 0, g = 0, b = 0;
                    
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            const pixelIdx = ((y + ky) * width + (x + kx)) * 4;
                            const kernelIdx = (ky + 1) * 3 + (kx + 1);
                            const weight = kernel[kernelIdx];
                            
                            r += data[pixelIdx] * weight;
                            g += data[pixelIdx + 1] * weight;
                            b += data[pixelIdx + 2] * weight;
                        }
                    }
                    
                    newData[idx] = Math.max(0, Math.min(255, r));
                    newData[idx + 1] = Math.max(0, Math.min(255, g));
                    newData[idx + 2] = Math.max(0, Math.min(255, b));
                }
            }
            
            const newImageData = new ImageData(newData, width, height);
            ctx.putImageData(newImageData, 0, 0);
        }

        function quantizeToGrayscale(imageData, colorCount) {
            const data = imageData.data;
            const palette = MAII_PALETTE[colorCount];
            threadCounts = {};
            
            // Initialize thread counts
            palette.forEach(color => {
                threadCounts[color.name] = 0;
            });

            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i];
                
                // Find closest palette color using better distance calculation
                let closestColor = palette[0];
                let minDistance = Math.abs(gray - closestColor.rgb[0]);
                
                for (let j = 1; j < palette.length; j++) {
                    const distance = Math.abs(gray - palette[j].rgb[0]);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestColor = palette[j];
                    }
                }
                
                // Apply the closest color
                data[i] = closestColor.rgb[0];
                data[i + 1] = closestColor.rgb[1];
                data[i + 2] = closestColor.rgb[2];
                
                // Count thread usage
                threadCounts[closestColor.name]++;
            }

            return imageData;
        }

        function createPatternDisplay(canvas, width, height) {
            const preview = document.getElementById('patternPreview');
            preview.innerHTML = '';
            
            // Create a larger display canvas for better visibility
            const displayCanvas = document.createElement('canvas');
            const displayCtx = displayCanvas.getContext('2d');
            const scale = Math.min(300 / width, 300 / height);
            
            displayCanvas.width = width * scale;
            displayCanvas.height = height * scale;
            displayCanvas.style.border = '1px solid #ddd';
            displayCanvas.style.borderRadius = '10px';
            displayCanvas.style.maxWidth = '100%';
            displayCanvas.style.maxHeight = '300px';
            
            // Draw scaled pattern without smoothing for crisp pixels
            displayCtx.imageSmoothingEnabled = false;
            displayCtx.drawImage(canvas, 0, 0, displayCanvas.width, displayCanvas.height);
            
            // Add grid lines for pattern effect
            displayCtx.strokeStyle = 'rgba(0, 0, 0, 0.15)';
            displayCtx.lineWidth = 0.5;
            
            const gridSize = scale;
            if (gridSize >= 3) { // Only show grid if pixels are large enough
                for (let x = 0; x <= displayCanvas.width; x += gridSize) {
                    displayCtx.beginPath();
                    displayCtx.moveTo(x, 0);
                    displayCtx.lineTo(x, displayCanvas.height);
                    displayCtx.stroke();
                }
                
                for (let y = 0; y <= displayCanvas.height; y += gridSize) {
                    displayCtx.beginPath();
                    displayCtx.moveTo(0, y);
                    displayCtx.lineTo(displayCanvas.width, y);
                    displayCtx.stroke();
                }
            }
            
            preview.appendChild(displayCanvas);
        }

        function updateColorPalette(colorCount) {
            const paletteContainer = document.getElementById('colorPalette');
            paletteContainer.innerHTML = '';
            
            const palette = MAII_PALETTE[colorCount];
            colorPalette = palette;
            
            paletteContainer.style.display = 'flex';
            paletteContainer.style.justifyContent = 'center';
            paletteContainer.style.gap = '10px';
            paletteContainer.style.marginTop = '15px';
            paletteContainer.style.flexWrap = 'wrap';
            
            palette.forEach((color, index) => {
                const swatch = document.createElement('div');
                swatch.style.width = '40px';
                swatch.style.height = '40px';
                swatch.style.borderRadius = '50%';
                swatch.style.border = '3px solid #fff';
                swatch.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                swatch.style.display = 'flex';
                swatch.style.alignItems = 'center';
                swatch.style.justifyContent = 'center';
                swatch.style.fontSize = '0.8rem';
                swatch.style.fontWeight = 'bold';
                swatch.style.color = color.rgb[0] > 128 ? '#000' : '#fff';
                swatch.style.backgroundColor = color.hex;
                swatch.textContent = index + 1;
                swatch.title = color.name;
                paletteContainer.appendChild(swatch);
            });
        }

        function calculateThreadCounts(imageData, colorCount) {
            const totalPixels = imageData.width * imageData.height;
            const stats = document.getElementById('patternStats');
            const threadCountContainer = document.getElementById('threadCount');
            
            stats.innerHTML = `
                <p><strong>Pattern Size:</strong> ${imageData.width} Ã— ${imageData.height} stitches</p>
                <p><strong>Total Stitches:</strong> ${totalPixels}</p>
                <p><strong>Colors Used:</strong> ${colorCount}</p>
            `;
            
            threadCountContainer.innerHTML = '';
            threadCountContainer.style.display = 'grid';
            threadCountContainer.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
            threadCountContainer.style.gap = '10px';
            threadCountContainer.style.marginTop = '10px';
            
            colorPalette.forEach((color, index) => {
                const count = threadCounts[color.name] || 0;
                const percentage = ((count / totalPixels) * 100).toFixed(1);
                
                const threadItem = document.createElement('div');
                threadItem.style.display = 'flex';
                threadItem.style.alignItems = 'center';
                threadItem.style.gap = '10px';
                threadItem.style.padding = '5px';
                threadItem.style.backgroundColor = 'white';
                threadItem.style.borderRadius = '5px';
                threadItem.style.border = '1px solid #ddd';
                
                const swatch = document.createElement('div');
                swatch.style.width = '20px';
                swatch.style.height = '20px';
                swatch.style.borderRadius = '50%';
                swatch.style.backgroundColor = color.hex;
                swatch.style.border = '2px solid #fff';
                swatch.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                swatch.style.display = 'flex';
                swatch.style.alignItems = 'center';
                swatch.style.justifyContent = 'center';
                swatch.style.fontSize = '0.7rem';
                swatch.style.fontWeight = 'bold';
                swatch.style.color = color.rgb[0] > 128 ? '#000' : '#fff';
                swatch.textContent = index + 1;
                
                const info = document.createElement('div');
                info.innerHTML = `
                    <strong>${color.name}</strong><br>
                    <small>${count} stitches (${percentage}%)</small>
                `;
                
                threadItem.appendChild(swatch);
                threadItem.appendChild(info);
                threadCountContainer.appendChild(threadItem);
            });
        }

        function exportPDF() {
            if (!processedCanvas) return;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Add title
            pdf.setFontSize(20);
            pdf.text('Punch Needle Pattern', 105, 20, { align: 'center' });
            
            // Add pattern image
            const canvasDataUrl = processedCanvas.toDataURL('image/png');
            const imgWidth = 120;
            const imgHeight = (processedCanvas.height / processedCanvas.width) * imgWidth;
            pdf.addImage(canvasDataUrl, 'PNG', 45, 35, imgWidth, imgHeight);
            
            // Add color legend
            let yPos = 35 + imgHeight + 20;
            pdf.setFontSize(16);
            pdf.text('Color Legend', 20, yPos);
            yPos += 10;
            
            pdf.setFontSize(12);
            colorPalette.forEach((color, index) => {
                pdf.setFillColor(color.rgb[0], color.rgb[1], color.rgb[2]);
                pdf.rect(20, yPos - 3, 8, 6, 'F');
                pdf.setTextColor(0, 0, 0);
                pdf.text(`${index + 1}. ${color.name} (${color.hex})`, 35, yPos);
                yPos += 8;
            });
            
            // Add thread count guide
            yPos += 10;
            pdf.setFontSize(16);
            pdf.text('Thread Count Guide', 20, yPos);
            yPos += 10;
            
            pdf.setFontSize(12);
            colorPalette.forEach((color, index) => {
                const count = threadCounts[color.name] || 0;
                const totalPixels = processedCanvas.width * processedCanvas.height;
                const percentage = ((count / totalPixels) * 100).toFixed(1);
                pdf.text(`${color.name}: ${count} stitches (${percentage}%)`, 20, yPos);
                yPos += 6;
            });
            
            // Add pattern info
            yPos += 10;
            pdf.setFontSize(16);
            pdf.text('Pattern Information', 20, yPos);
            yPos += 10;
            
            pdf.setFontSize(12);
            pdf.text(`Pattern Size: ${processedCanvas.width} Ã— ${processedCanvas.height} stitches`, 20, yPos);
            yPos += 6;
            pdf.text(`Total Stitches: ${processedCanvas.width * processedCanvas.height}`, 20, yPos);
            yPos += 6;
            pdf.text(`Colors Used: ${colorPalette.length}`, 20, yPos);
            
            // Save the PDF
            pdf.save('punch-needle-pattern.pdf');
        }
    </script>
</body>
</html>